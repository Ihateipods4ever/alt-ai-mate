<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Preview</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <style>
    body {
      position: relative; /* Needed for absolute positioning of the button */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: white;
    }
    #refreshButton {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    #root {
      min-height: 100vh;
      padding: 1rem;
    }
    #error-display {
      color: red;
      padding: 20px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <button id="refreshButton">Refresh</button>
  <div id="root"></div>
  <script type="module">
    const root = ReactDOM.createRoot(document.getElementById('root'));
    const errorDisplay = document.createElement('div');
    errorDisplay.id = 'error-display';
    document.body.appendChild(errorDisplay);

    const renderPreview = (code, css) => {
      // Clear previous content and errors
      root.render(null);
      errorDisplay.innerHTML = ''; // Clear previous errors
      document.querySelectorAll('style[data-dynamic-style]').forEach(el => el.remove());

      try {
        // Add CSS
        if (css) {
          const style = document.createElement('style');
          style.setAttribute('data-dynamic-style', 'true');
          style.innerHTML = css;
          document.head.appendChild(style);
        }

        // Create a function from the code and execute it
        const App = new Function('React', 'ReactDOM', code)(React, ReactDOM);
        
        // Render the main component
        if (typeof App !== 'undefined') {
          root.render(React.createElement(App));
        } else {
          // Fallback if no App component is found after execution
          root.render(
            React.createElement('div', { style: { color: 'orange', padding: '20px' } },
              React.createElement('h3', null, 'No App component found'),
              React.createElement('p', null, 'Make sure your code exports a default App component.')
            )
          );
        }

      } catch (err) {
        console.error('Preview Error:', err);
        displayError('Preview Error', err);
      }
    };

    const displayError = (title, error) => {
        errorDisplay.innerHTML = `
            <h3>${title}</h3>
            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto;">${error.message || error}</pre>
            <details style="margin-top: 10px;">
              <summary>Stack Trace</summary>
              <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; font-size: 12px;">${error.stack || 'No stack trace available'}</pre>
            </details>`;
    };

    // Log to confirm script starts
    console.log('Preview iframe script running.');

    // Store the last received code and css globally or in a way accessible to the click handler
    let lastCode = '';
    let lastCss = '';

    window.addEventListener('message', (event) => {
      // IMPORTANT: Add a security check for the origin of the message
      // if (event.origin !== 'http://localhost:5173') return;

      const { code, css } = event.data;

      // Store the last received code and css
      lastCode = code;
      lastCss = css;

      // Render the preview with the received data
      renderPreview(lastCode, lastCss);
    }, false);

    // Add event listener for the refresh button
    document.getElementById('refreshButton').addEventListener('click', () => {
      renderPreview(lastCode, lastCss); // Use the stored values
    });

    // Global error handler for any uncaught errors
    window.onerror = (message, source, lineno, colno, error) => {
        displayError('Uncaught Error', error || { message: message, stack: `${source}:${lineno}:${colno}` });
        return true; // Prevent default browser error handling
    };
  </script>
</body>
</html>
